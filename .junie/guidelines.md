# Guidelines

## Project Architecture

- Entry point in `main.go` builds the Fyne app and wires dependencies via `internal/ui/app`.
- The projects uses the following design principles:
  - layered architecture: view, viewmodel, domain, infrastructure
  - clean architecture: the domain layer is independent of the UI and infrastructure layers
  - event-driven architecture: domain events flow through a shared event bus
  - Domain Driven Design: entities, aggregates, value objects, domain services, the domain is described in the `domain` folder.
  - MVVM: model-view-viewmodel (viewmodel is a wrapper around domain entities and acts as a use cases layer)
- `internal/domain` holds core models and events (`connection_deck`, `directory`, `settings`, `notification`, shared event bus interfaces). Root entities are `connection_deck.ConnectionDeck` and `directory.Directory`.
- `internal/infrastructure` implements repositories/adapters: S3 access (AWS SDK v2), Fyne preferences storage, DTO mappings, and notification publishing.
- `internal/ui` is the presentation layer: `app` bootstraps window/context/navigation, `viewmodel` coordinates domain + infrastructure, `views` render Fyne widgets, `theme`/`resources` provide assets.
- Events flow through the shared `event.Bus` interface, with the concrete implementation in `internal/ui/app/event_bus.go`.

## Testing Guidelines

- Use `testing` with `testify/assert` and `testify/require`; reserve `require` for setup preconditions, then use `assert` for expectations.
- Structure tests with `t.Run("should ...")` subtests and `// Given`, `// When`, `// Then` comments (or `// Given & Then`) for readability.
- Prefer explicit error checks: `assert.ErrorIs` for sentinel errors and `assert.Contains` for error message fragments when needed.
- Use `gomock` for dependencies; mocks live under `mocks/...`. Create a controller via `gomock.NewController(t)`
- For event-driven tests, stub the bus with `Subscribe()` returning a channel, and assert published events via `gomock.Eq` or `gomock.Cond` for payload inspection.
- Test must be written under a `*_test` package for regular test failes `*_test.go`. You must test exported functions and methods in priority.
- To test internal functions or methods (not recommended), put tesst under a `*_internal_test.go` file and use the same package name than the file you want to test.
- Content under `mocks` directory is generated by `mockgen`. Don't edit manually. Use the `go generate` command to regenerate mocks.
- Mock are declared in the file `gen.go`

### Domain Tests

- Use constructors from domain packages (`connection_deck.New`, `directory.New`, `directory.NewFile`, etc.) and verify state via public methods.
- For directory load/remove flows, call `dir.Load()` before `Notify(...)` to set the loading state, then `Notify` with:
  - `directory.NewLoadSuccessEvent` to set content,
  - `directory.NewFileDeletedSuccessEvent` or `directory.NewDeletedSuccessEvent` to update state after removal.
- Assert removal by checking `dir.Files()` or `dir.SubDirectories()` lengths and contents rather than only the event payload.
- Use `directory.RootDirName` + `directory.NilParentPath` for the root directory, or `directory.RootPath` when needed for paths.

### Infrastructure Tests

- Integration with S3 uses `testcontainers-go/modules/localstack` in `internal/infrastructure` tests only.
- Use helper setup functions (`setupS3testContainer`, `setupS3Client`, `setupS3Bucket`) and always terminate the container.
- Prefer `context.Background()` and mock repositories/bus/notification using `gomock`.
- Use AWS SDK v2 clients (`github.com/aws/aws-sdk-go-v2/service/s3`) with path-style requests and custom endpoints.

### UI Tests (Fyne)

- Initialize Fyne with `fyne_test.NewApp()` (or `fyne_test.NewTempApp(t)` when appropriate).
- Render widgets with `fyne_test.NewWindow(res).Canvas()` and compare using `fyne_test.AssertRendersToMarkup(t, "<name>", canvas)`.
- Simulate interactions with `fyne_test.Tap` when needed.
- Use data bindings (`binding.NewTree`, `binding.NewUntypedList`, `binding.NewString`) to feed viewmodels.
- Mock app context and viewmodels via `mocks/context` and `mocks/viewmodel`, using `AnyTimes()` for repeated calls.

### DTO Tests

- Serialize/deserialize using `encoding/json` and validate with `assert.JSONEq` for deterministic comparisons.

